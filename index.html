<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TowerStory</title>
  <style>
    html, body { height:100%; width:100%; margin:0; padding:0; background: url('assets/images/background.png') center/cover no-repeat; }
    body { display:grid; grid-template-rows:80px auto 60px; grid-template-columns:200px auto 200px;
      grid-template-areas:"header header header" "sidebar-left main sidebar-right" "footer footer footer";
      align-items:center; justify-items:center; }
    #header{grid-area:header;} #sidebar-left{grid-area:sidebar-left;} #sidebar-right{grid-area:sidebar-right;} #footer{grid-area:footer;}
    #game-container{grid-area:main; display:flex; align-items:center; justify-content:center; width:100%; height:100%; overflow:hidden;}
    #game-container canvas{max-width:100%; max-height:100%;}
  </style>
</head>
<body>
  <div id="header"></div>
  <div id="sidebar-left"></div>
  <div id="game-container"></div>
  <div id="sidebar-right"></div>
  <div id="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
  <script>
    window.addEventListener('load', () => {
      class BootScene extends Phaser.Scene { constructor(){super('Boot');} create(){this.scene.start('Preload');} }
      class PreloadScene extends Phaser.Scene {
        constructor(){super('Preload');}
        preload(){
          this.load.tilemapTiledJSON('room','assets/maps/room.json');
          this.load.spritesheet('tileset','assets/tiles/tileset.png',{frameWidth:38,frameHeight:38});
          this.load.spritesheet('player','assets/player/Chibi-character-template_skin0_part2_by_AxulArt.png',{frameWidth:32,frameHeight:32});
          this.load.image('chest','assets/objects/chest.png');
          this.load.image('npc','assets/objects/npc.png');
          this.load.image('potion','assets/icons/potion.png');
          this.load.image('sword','assets/icons/sword.png');
          this.load.image('coin','assets/icons/coin.png');
        }
        create(){this.scene.start('Main');}
      }
      class MainScene extends Phaser.Scene { /* unchanged */ }

      // Inventory UI with frame, title and drag-and-drop
      class InventoryScene extends Phaser.Scene {
        constructor(){super('InventoryScene');}
        init(data){ this.playerInv = data.playerInv; this.chestInv = data.chestInv; }
        create(){
          const width = this.scale.width;
          const height = this.scale.height;
          // Panel dimensions
          this.leftPanel = new Phaser.Geom.Rectangle(50,50,200,300);
          this.rightPanel = new Phaser.Geom.Rectangle(width-250,50,200,300);
          // Draw frames and titles
          this.graphics = this.add.graphics();
          this.graphics.fillStyle(0x222222,0.8);
          this.graphics.fillRectShape(this.leftPanel);
          this.graphics.fillRectShape(this.rightPanel);
          this.add.text(this.leftPanel.x+10,this.leftPanel.y+10,'Inventory',{fontSize:'16px',fill:'#fff'});
          this.add.text(this.rightPanel.x+10,this.rightPanel.y+10,'Chest',{fontSize:'16px',fill:'#fff'});
          // Input drag listeners
          this.input.on('dragstart',(pointer,gameObj)=>{ gameObj.setDepth(1000); });
          this.input.on('drag',(pointer,gameObj,dragX,dragY)=>{ gameObj.x=dragX; gameObj.y=dragY; });
          this.input.on('dragend', this.onDragEnd, this);
          this.drawInventory();
          // ESC to close
          this.input.keyboard.on('keydown-ESC',()=>this.close());
        }
        drawInventory(){
          if(this.iconsGroup) this.iconsGroup.clear(true,true);
          this.iconsGroup = this.add.group();
          // player slots
          this.playerInv.forEach((item,i)=>{
            const col=i%4, row=Math.floor(i/4);
            const x=this.leftPanel.x+10+col*48, y=this.leftPanel.y+40+row*48;
            const slot=this.add.rectangle(x,y,44,44,0x444444).setOrigin(0);
            const icon=this.add.image(x+22,y+22,item.iconKey)
                               .setInteractive({draggable:true})
                               .setData('source','player')
                               .setData('index',i);
            this.iconsGroup.add(icon);
          });
          // chest slots
          this.chestInv.forEach((item,i)=>{
            const col=i%4, row=Math.floor(i/4);
            const x=this.rightPanel.x+10+col*48, y=this.rightPanel.y+40+row*48;
            const slot=this.add.rectangle(x,y,44,44,0x444444).setOrigin(0);
            const icon=this.add.image(x+22,y+22,item.iconKey)
                               .setInteractive({draggable:true})
                               .setData('source','chest')
                               .setData('index',i);
            this.iconsGroup.add(icon);
          });
        }
        onDragEnd(pointer,gameObj){
          const x=pointer.x, y=pointer.y;
          let from=gameObj.getData('source'), idx=gameObj.getData('index');
          let srcArr = from==='player'?this.playerInv:this.chestInv;
          let destArr= from==='player'?this.chestInv:this.playerInv;
          // Determine drop target
          if(this.leftPanel.contains(x,y) && from==='chest'){
            const item=this.chestInv.splice(idx,1)[0]; this.playerInv.push(item);
          } else if(this.rightPanel.contains(x,y) && from==='player'){
            const item=this.playerInv.splice(idx,1)[0]; this.chestInv.push(item);
          }
          this.drawInventory();
        }
        close(){
          this.scene.get('Main').events.emit('inventoryClosed',{playerInv:this.playerInv,chestInv:this.chestInv});
          this.scene.stop();
        }
      }

      const config={ type:Phaser.AUTO, parent:'game-container', scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH}, physics:{default:'arcade'}, scene:[BootScene,PreloadScene,MainScene,InventoryScene] };
      new Phaser.Game(config);
    });
  </script>
</body>
</html>
