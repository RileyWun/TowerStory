<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TowerStory</title>
  <style>
    html, body { height:100%; margin:0; padding:0; background:url('assets/images/background.png') center/cover no-repeat; }
    body {
      display:grid;
      grid-template-rows:80px auto 60px;
      grid-template-columns:200px auto 200px;
      grid-template-areas:
        "header header header"
        "sidebar-left main sidebar-right"
        "footer footer footer";
    }
    #header { grid-area: header; }
    #sidebar-left { grid-area: sidebar-left; }
    #game-container { grid-area: main; position:relative; width:100%; height:100%; overflow:hidden; }
    #sidebar-right { grid-area: sidebar-right; }
    #footer { grid-area: footer; }
    #game-container canvas { display:block; margin:auto; }
  </style>
</head>
<body>
  <div id="header"></div>
  <div id="sidebar-left"></div>
  <div id="game-container"></div>
  <div id="sidebar-right"></div>
  <div id="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
  <script>
    window.addEventListener('load', () => {
      // Boot Scene
      class BootScene extends Phaser.Scene {
        constructor() { super('Boot'); }
        create(){
          const w = this.scale.width;
          this.pw = 200; this.ph = 300;
          this.leftPanel  = new Phaser.Geom.Rectangle(50,50,this.pw,this.ph);
          if (this.showChest) {
            this.rightPanel = new Phaser.Geom.Rectangle(w-50-this.pw,50,this.pw,this.ph);
          }
          this.uiGroup = this.add.group();

          // Title bar drag zones
          this.leftZone = this.add.zone(this.leftPanel.x,this.leftPanel.y,this.pw,20).setOrigin(0).setInteractive();
          if (this.showChest) {
            this.rightZone = this.add.zone(this.rightPanel.x,this.rightPanel.y,this.pw,20).setOrigin(0).setInteractive();
            this.input.setDraggable([this.leftZone,this.rightZone]);
          } else {
            this.input.setDraggable([this.leftZone]);
          }

          // Drag events
          this.input.on('drag', (pointer, obj, dx, dy) => {
            if (obj === this.leftZone) {
              this.leftPanel.x = dx; this.leftZone.x = dx;
              this.leftPanel.y = dy; this.leftZone.y = dy;
              this.redraw();
            } else if (this.showChest && obj === this.rightZone) {
              this.rightPanel.x = dx; this.rightZone.x = dx;
              this.rightPanel.y = dy; this.rightZone.y = dy;
              this.redraw();
            } else {
              // Dragging an item
              obj.x = dx; obj.y = dy;
            }
          });
          this.input.on('dragend', this.onDragEnd, this);

          // Close keys
          this.input.keyboard.on('keydown-ESC', () => this.close());
          this.input.keyboard.on('keydown-I', () => this.close());

          this.redraw();
            } else if (this.showChest && obj === this.rightZone) {
              this.rightPanel.x = dx; this.rightZone.x = dx; this.rightPanel.y = dy; this.rightZone.y = dy;
              this.redraw();
            } else {
              // Dragging an item
              obj.x = dx; obj.y = dy;
            }
          });
          this.input.on('dragend',this.onDragEnd,this);

          // Close keys
          this.input.keyboard.on('keydown-ESC',()=>this.close());
          this.input.keyboard.on('keydown-I',()=>this.close());

          this.redraw();
         else if (obj===this.rightZone) {
              this.rightPanel.x=dx; this.rightZone.x=dx; this.rightPanel.y=dy; this.rightZone.y=dy;
              this.redraw();
            } else {
              obj.x=dx; obj.y=dy;
            }
          });
          this.input.on('dragend',this.onDragEnd,this);

          // Close keys
          this.input.keyboard.on('keydown-ESC',()=>this.close());
          this.input.keyboard.on('keydown-I',()=>this.close());

          this.redraw();
        }

        redraw(){
          this.uiGroup.clear(true,true);
          const g=this.add.graphics().fillStyle(0x222222,0.8);
          g.fillRectShape(this.leftPanel).fillRectShape(this.rightPanel)
           .fillStyle(0x333333,1).fillRect(this.leftPanel.x,this.leftPanel.y,this.pw,20)
           .fillRect(this.rightPanel.x,this.rightPanel.y,this.pw,20);
          this.uiGroup.add(g);
          this.uiGroup.add(this.add.text(this.leftPanel.x+10,this.leftPanel.y+4,'Inventory',{fontSize:'16px',fill:'#fff'}).setDepth(1));
          this.uiGroup.add(this.add.text(this.rightPanel.x+10,this.rightPanel.y+4,'Chest',{fontSize:'16px',fill:'#fff'}).setDepth(1));
          this.drawSlots(this.leftPanel,this.playerInv,'player');
          this.drawSlots(this.rightPanel,this.chestInv,'chest');
        }

        drawSlots(panel,arr,src){ const cols=4,rows=5;
          arr.forEach((it,i)=>{ const cnt=it.count||1; const c=i%cols; const r=Math.floor(i/cols); if(r>=rows)return;
            const x=panel.x+10+c*48; const y=panel.y+40+r*48;
            this.uiGroup.add(this.add.rectangle(x,y,44,44,0x444444).setOrigin(0));
            const icon=this.add.image(x+22,y+22,it.iconKey).setInteractive({draggable:true}).setData('source',src).setData('index',i);
            this.uiGroup.add(icon);
            if(cnt>1) this.uiGroup.add(this.add.text(x+32,y+32,cnt+'',{fontSize:'12px',fill:'#fff'}).setOrigin(1));
          });
        }

        onDragEnd(p,icon){ const src=icon.getData('source'); if(!src) return;
          const idx=icon.getData('index'); const srcArr=src==='player'?this.playerInv:this.chestInv;
          if(idx<0||idx>=srcArr.length) return;
          const dstArr=src==='player'?this.chestInv:this.playerInv;
          const dstPanel=src==='player'?this.rightPanel:this.leftPanel;
          const x=p.x,y=p.y;
          if(dstPanel.contains(x,y)){
            const item=srcArr[idx]; const ex=dstArr.find(i=>i.iconKey===item.iconKey);
            if(ex) ex.count+=item.count||1;
            else if(dstArr.length<20) dstArr.push({iconKey:item.iconKey,count:item.count||1});
            srcArr.splice(idx,1);
          }
          this.redraw();
        }

        close(){ this.scene.stop(); this.scene.get('Main').scene.resume(); }
      }

      // Game configuration
      const config={
        type: Phaser.AUTO,
        parent: 'game-container',
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
        physics: { default: 'arcade' },
        scene: [BootScene, PreloadScene, MainScene, InventoryScene]
      };
      new Phaser.Game(config);
    });
  </script>
</body>
</html>
