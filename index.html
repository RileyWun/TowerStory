<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TowerStory</title>
  <style>
    html, body { height:100%; margin:0; padding:0; background:url('assets/images/background.png') center/cover no-repeat; }
    body { display:grid; grid-template-rows:80px auto 60px; grid-template-columns:200px auto 200px; grid-template-areas:"header header header" "sidebar-left main sidebar-right" "footer footer footer"; }
    #header { grid-area: header; }
    #sidebar-left { grid-area: sidebar-left; }
    #game-container { grid-area: main; position:relative; width:100%; height:100%; overflow:hidden; }
    #sidebar-right { grid-area: sidebar-right; }
    #footer { grid-area: footer; }
    #game-container canvas { display:block; margin:auto; }
  </style>
</head>
<body>
  <div id="header"></div>
  <div id="sidebar-left"></div>
  <div id="game-container"></div>
  <div id="sidebar-right"></div>
  <div id="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
  <script>
    window.addEventListener('load', () => {
      class BootScene extends Phaser.Scene {
        constructor() { super('Boot'); }
        create() { this.scene.start('Preload'); }
      }

      class PreloadScene extends Phaser.Scene {
        constructor() { super('Preload'); }
        preload() {
          this.load.tilemapTiledJSON('room', 'assets/maps/room.json');
          this.load.spritesheet('tileset', 'assets/tiles/tileset.png', { frameWidth:38, frameHeight:38 });
          this.load.spritesheet('player', 'assets/player/Chibi-character-template_skin0_part2_by_AxulArt.png', { frameWidth:32, frameHeight:32 });
          this.load.image('chest', 'assets/objects/chest.png');
          this.load.image('npc', 'assets/objects/npc.png');
          this.load.image('potion', 'assets/icons/potion.png');
          this.load.image('sword', 'assets/icons/sword.png');
          this.load.image('coin', 'assets/icons/coin.png');
        }
        create() { this.scene.start('Main'); }
      }

      class MainScene extends Phaser.Scene {
        constructor() { super('Main'); }
        create() {
          const map = this.make.tilemap({ key: 'room' });
          // Store map and tile dimensions
          this.tileW = map.tileWidth;
          this.tileH = map.tileHeight;
          this.mapW = map.width;
          this.mapH = map.height;
          const tileset = map.addTilesetImage('tileset', 'tileset', map.tileWidth, map.tileHeight);
          // Floor
          this.offsetX = this.scale.width / 2;
          this.offsetY = (this.scale.height - (map.width + map.height) * (map.tileHeight / 2)) / 2 + map.tileHeight/2;
          this.floorData = map.getLayer('Floor').data.map(r => r.map(t => t.index > 0));
          this.collisionData = map.getLayer('Collision').data.map(r => r.map(t => t.index > 0));
          map.getLayer('Floor').data.forEach((row, y) => {
            row.forEach((tile, x) => {
              if (tile.index > 0) {
                const frame = tile.index - 1;
                const sx = (x - y) * (map.tileWidth / 2) + this.offsetX;
                const sy = (x + y) * (map.tileHeight / 2) + this.offsetY;
                this.add.image(sx, sy, 'tileset', frame).setDepth(sy);
              }
            });
          });
          // Objects
          const objLayer = map.getObjectLayer('Objects');
          const spawn = map.findObject('Objects', o => o.name === 'PlayerSpawn');
          objLayer.objects.push({ name:'Chest1', type:'Chest', x: spawn.x + map.tileWidth*2, y: spawn.y, visible:true });
          objLayer.objects.push({ name:'NPC1',   type:'NPC',   x: spawn.x - map.tileWidth*2, y: spawn.y, visible:true });

          this.playerInv = [{ iconKey:'potion', count:3 },{ iconKey:'sword', count:1 }];
          this.chests = [];
          objLayer.objects.forEach(o => {
            const ix = o.x / map.tileWidth, iy = o.y / map.tileHeight;
            const sx = (ix - iy) * (map.tileWidth / 2) + this.offsetX;
            const sy = (ix + iy) * (map.tileHeight / 2) + this.offsetY;
            if (o.type === 'Chest') {
              const chest = this.add.image(sx, sy, 'chest').setOrigin(0.5,1).setDepth(sy).setInteractive();
              chest.inventory = [{ iconKey:'coin', count:2 },{ iconKey:'potion', count:1 }];
              chest.on('pointerdown', () => {
                this.scene.pause();
                this.scene.launch('InventoryScene', { playerInv: this.playerInv, chestInv: chest.inventory });
              });
              this.chests.push(chest);
            } else if (o.type === 'NPC') {
              this.add.image(sx, sy, 'npc').setOrigin(0.5,1).setDepth(sy);
            }
          });
          // Player
          this.player = this.add.sprite(0,0,'player').setOrigin(0.5,1);
          this.createPlayerAnims();
          this.playerIsoX = spawn.x/map.tileWidth;
          this.playerIsoY = spawn.y/map.tileHeight;
          this.keys = this.input.keyboard.addKeys('W,A,S,D');
          this.cameras.main.setBounds(0,0,map.widthInPixels,map.heightInPixels);
          this.cameras.main.startFollow(this.player,true,0.1,0.1);
          this.events.on('inventoryClosed', data => {
            this.playerInv = data.playerInv;
            this.chests[0].inventory = data.chestInv;
            this.scene.resume();
          });

          // Toggle inventory with "I"
          this.input.keyboard.on('keydown-I', () => {
            if (!this.scene.isActive('InventoryScene')) {
              this.scene.pause();
              this.scene.launch('InventoryScene', { playerInv: this.playerInv, chestInv: [] });
            }
          });

          // Open chest with "E" when near
          this.input.keyboard.on('keydown-E', () => {
            const px = this.player.x;
            const py = this.player.y;
            for (const chest of this.chests) {
              const dist = Phaser.Math.Distance.Between(px, py, chest.x, chest.y);
              if (dist < 50) {
                this.scene.pause();
                this.scene.launch('InventoryScene', { playerInv: this.playerInv, chestInv: chest.inventory });
                break;
              }
            }
          });
      new Phaser.Game(config);
      });
  </script>
</body>
</html>
