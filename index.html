<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TowerStory</title>
  <style>
    html, body { height:100%; width:100%; margin:0; padding:0; background: url('assets/images/background.png') center/cover no-repeat; }
    body { display:grid; grid-template-rows:80px auto 60px; grid-template-columns:200px auto 200px;
      grid-template-areas: "header header header" "sidebar-left main sidebar-right" "footer footer footer";
      align-items:center; justify-items:center; }
    #header { grid-area: header; }
    #sidebar-left { grid-area: sidebar-left; }
    #sidebar-right { grid-area: sidebar-right; }
    #footer { grid-area: footer; }
    #game-container {
      grid-area: main;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%; height: 100%; overflow: hidden;
    }
    #game-container canvas { max-width: 100%; max-height: 100%; }
  </style>
</head>
<body>
  <div id="header"></div>
  <div id="sidebar-left"></div>
  <div id="game-container"></div>
  <div id="sidebar-right"></div>
  <div id="footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
  <script>
    window.addEventListener('load', () => {
      class BootScene extends Phaser.Scene {
        constructor(){ super('Boot'); }
        create(){ this.scene.start('Preload'); }
      }

      class PreloadScene extends Phaser.Scene {
        constructor(){ super('Preload'); }
        preload(){
          this.load.tilemapTiledJSON('room','assets/maps/room.json');
          this.load.spritesheet('tileset','assets/tiles/tileset.png',{frameWidth:38,frameHeight:38});
          this.load.spritesheet('player','assets/player/Chibi-character-template_skin0_part2_by_AxulArt.png',{frameWidth:32,frameHeight:32});
          this.load.image('chest','assets/objects/chest.png');
          this.load.image('npc','assets/objects/npc.png');
          this.load.image('potion','assets/icons/potion.png');
          this.load.image('sword','assets/icons/sword.png');
          this.load.image('coin','assets/icons/coin.png');
        }
        create(){ this.scene.start('Main'); }
      }

      class MainScene extends Phaser.Scene {
        constructor(){ super('Main'); }
        create(){ /* MainScene code as before (floor, player, chests) */ }
        update(){ /* MainScene movement & collision */ }
        // Include createPlayerAnims and updatePlayerPosition here
      }

      class InventoryScene extends Phaser.Scene {
        constructor(){ super('InventoryScene'); }
        init(data){ this.playerInv = data.playerInv; this.chestInv = data.chestInv; }
        create(){
          const width = this.scale.width, height = this.scale.height;
          this.panelWidth = 200; this.panelHeight = 300;
          this.leftPanel = new Phaser.Geom.Rectangle(50,50,this.panelWidth,this.panelHeight);
          this.rightPanel = new Phaser.Geom.Rectangle(width-250,50,this.panelWidth,this.panelHeight);

          // Background frames
          this.graphics = this.add.graphics();
          this.graphics.fillStyle(0x222222,0.8);
          this.graphics.fillRectShape(this.leftPanel);
          this.graphics.fillRectShape(this.rightPanel);

          // Titles
          this.add.text(this.leftPanel.x+10,this.leftPanel.y+10,'Inventory',{fontSize:'16px',fill:'#fff'});
          this.add.text(this.rightPanel.x+10,this.rightPanel.y+10,'Chest',{fontSize:'16px',fill:'#fff'});

          // Draw slots and icons
          this.drawSlots(this.leftPanel,this.playerInv,'player');
          this.drawSlots(this.rightPanel,this.chestInv,'chest');

          // Enable drag for panels
          thisleftZone = this.add.zone(this.leftPanel.x,this.leftPanel.y,this.panelWidth,20).setOrigin(0).setInteractive();
          thisrightZone= this.add.zone(this.rightPanel.x,this.rightPanel.y,this.panelWidth,20).setOrigin(0).setInteractive();
          this.input.setDraggable([this.leftZone,this.rightZone]);
          this.input.on('drag', (pointer, gameObj, dragX, dragY) => {
            if (gameObj === this.leftZone) {
              this.leftPanel.x = dragX; this.leftZone.x = dragX;
              this.leftPanel.y = dragY; this.leftZone.y = dragY;
            } else if (gameObj === this.rightZone) {
              this.rightPanel.x = dragX; this.rightZone.x = dragX;
              this.rightPanel.y = dragY; this.rightZone.y = dragY;
            }
            this.redraw();
          });

          // Drag icons
          this.input.on('dragstart',(pointer,icon)=>icon.setDepth(1000));
          this.input.on('drag',(pointer,icon,dragX,dragY)=>{ icon.x=dragX; icon.y=dragY; });
          this.input.on('dragend',this.onDragEnd,this);

          this.input.keyboard.on('keydown-ESC',()=>this.close());
        }
        redraw(){
          this.graphics.clear();
          this.graphics.fillStyle(0x222222,0.8);
          this.graphics.fillRectShape(this.leftPanel);
          this.graphics.fillRectShape(this.rightPanel);
          this.drawSlots(this.leftPanel,this.playerInv,'player');
          this.drawSlots(this.rightPanel,this.chestInv,'chest');
        }
        drawSlots(panel,arr,source){ const maxCols=4,maxRows=5;
          arr.forEach((item,i)=>{ const count=item.count||1;
            const col=i%maxCols,row=Math.floor(i/maxCols); if(row>=maxRows) return;
            const x = panel.x+10+col*48, y = panel.y+40+row*48;
            this.add.rectangle(x,y,44,44,0x444444).setOrigin(0);
            const icon = this.add.image(x+22,y+22,item.iconKey)
                              .setInteractive({draggable:true})
                              .setData({source, index:i});
            if (count>1) this.add.text(x+32,y+32,count.toString(),{fontSize:'12px',fill:'#fff'}).setOrigin(1);
          });
        }
        onDragEnd(pointer,icon){ const x=pointer.x,y=pointer.y;
          const from=icon.getData('source'),idx=icon.getData('index');
          const srcArr = from==='player'?this.playerInv:this.chestInv;
          const dstArr = from==='player'?this.chestInv:this.playerInv;
          const dstPanel = from==='player'?this.rightPanel:this.leftPanel;
          if (dstPanel.contains(x,y)){
            const itm = srcArr[idx]; const exist = dstArr.find(i=>i.iconKey===itm.iconKey);
            if (exist) exist.count+=itm.count||1;
            else if (dstArr.length<20) dstArr.push({iconKey:itm.iconKey,count:itm.count||1});
            srcArr.splice(idx,1);
          }
          this.redraw();
        }
        close(){ this.scene.get('Main').events.emit('inventoryClosed', {playerInv:this.playerInv,chestInv:this.chestInv}); this.scene.stop(); }
      }

      const config = { type: Phaser.AUTO, parent:'game-container', scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH}, physics:{default:'arcade'}, scene:[BootScene,PreloadScene,MainScene,InventoryScene] };
      new Phaser.Game(config);
    });
  </script>
</body>
</html>
