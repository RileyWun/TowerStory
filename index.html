<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TowerStory</title>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    #game-container { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="game-container"></div>

  <!-- Phaser 3 -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>

  <script>
    // --- Boot Scene ---
    class BootScene extends Phaser.Scene {
      constructor() { super('Boot'); }
      preload() {}
      create() { this.scene.start('Preload'); }
    }

    // --- Preload Scene ---
    class PreloadScene extends Phaser.Scene {
      constructor() { super('Preload'); }
      preload() {
        // Load assets
        this.load.image('tile', 'assets/tiles/tile.png');
        this.load.image('player', 'assets/player/player.png');
      }
      create() { this.scene.start('Main'); }
    }

    // --- Main Scene (Manual Iso Projection) ---
    class MainScene extends Phaser.Scene {
      constructor() { super('Main'); }
      create() {
        // Iso grid parameters
        const tileW = 38, tileH = 38;
        const mapW = 20, mapH = 20;
        const offsetX = (mapW * tileW) / 2;
        const offsetY = 50;

        // Create tiles using manual iso projection
        this.tilesGroup = this.add.group();
        for (let x = 0; x < mapW; x++) {
          for (let y = 0; y < mapH; y++) {
            const screenX = (x - y) * (tileW / 2) + offsetX;
            const screenY = (x + y) * (tileH / 2) + offsetY;
            const tile = this.add.image(screenX, screenY, 'tile');
            tile.setDepth(screenY);
            this.tilesGroup.add(tile);
          }
        }

        // Player initial iso coords
        this.playerIsoX = mapW / 2;
        this.playerIsoY = mapH / 2;
        this.player = this.add.image(0, 0, 'player');
        this.player.setOrigin(0.5, 0.9);

        // Input keys (WASD)
        this.keys = this.input.keyboard.addKeys({
          up: 'W', left: 'A', down: 'S', right: 'D'
        });

        // Camera follow
        const cam = this.cameras.main;
        cam.setBounds(0, 0, mapW * tileW, mapH * tileH);
        cam.startFollow(this.player, true, 0.1, 0.1);

        // Initial render
        this.updatePlayerPosition(tileW, tileH, offsetX, offsetY);
      }

      update(time, delta) {
        const dt = delta / 1000;
        const speed = 3; // tiles per second
        if (this.keys.left.isDown)  this.playerIsoX -= speed * dt;
        if (this.keys.right.isDown) this.playerIsoX += speed * dt;
        if (this.keys.up.isDown)    this.playerIsoY -= speed * dt;
        if (this.keys.down.isDown)  this.playerIsoY += speed * dt;
        // Clamp
        this.playerIsoX = Phaser.Math.Clamp(this.playerIsoX, 0, 19);
        this.playerIsoY = Phaser.Math.Clamp(this.playerIsoY, 0, 19);

        // Update transform
        this.updatePlayerPosition(38, 38, (20*38)/2, 50);
      }

      updatePlayerPosition(tileW, tileH, offsetX, offsetY) {
        const isoX = this.playerIsoX;
        const isoY = this.playerIsoY;
        const screenX = (isoX - isoY) * (tileW / 2) + offsetX;
        const screenY = (isoX + isoY) * (tileH / 2) + offsetY;
        this.player.setPosition(screenX, screenY);
        this.player.setDepth(screenY);
      }
    }

    // --- Game Config & Launch ---
    window.addEventListener('load', () => {
      const config = {
        type: Phaser.AUTO,
        parent: 'game-container',
        width: window.innerWidth,
        height: window.innerHeight,
        backgroundColor: '#1d212d',
        scene: [BootScene, PreloadScene, MainScene]
      };
      new Phaser.Game(config);
    });
  </script>
</body>
</html>
